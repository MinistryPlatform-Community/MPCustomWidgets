{%- comment -%}
Domino’s-style volunteer tracker with large, boldly colored segments that "light up".
Top-level inputs expected:
 - volunteer_information (object)
 - background_checks (array)
 - milestones (array)
 - certifications (array)
 - forms (array)
 - leader_review (string: "completed" or "pending")
 - widgetId (optional), userAuthenticated (optional) — not displayed
Stages (left → right):
 1) Received (always complete)
 2) Leader Review (from `leader_review`)
 3) Background Check (all background_checks complete OR none => complete)
 4) Additional Requirements (all milestones+certifications+forms complete OR none => complete)
 5) Ready to Serve! (when 2–4 complete)
{%- endcomment -%}

{% assign vi = volunteer_information %}

{% comment %} Guard: only render tracker for volunteer-type groups {% endcomment %}
{% assign vol_raw = vi["Is_Volunteer_Group"] %}
{% assign vol_txt = vol_raw | downcase | strip %}
{% assign is_volunteer = false %}
{% if vol_raw == 1 or vol_txt == '1' or vol_raw == true or vol_txt == 'true' %}
  {% assign is_volunteer = true %}
{% endif %}

{% if is_volunteer == false %}
  <div class="vt-shell">
    <section class="vt-empty">
      <p><strong>{{ vi["Opportunity_Title"] | default: "This opportunity" }}</strong> is not configured as a volunteer team. Tracker not available.</p>
    </section>
  </div>
  <style>
    .vt-empty{
      margin:1.25rem auto;
      max-width:1080px;
      padding:.9rem 1rem;
      border:1px dashed #fbbf24;
      background:#fffbeb;
      color:#7c2d12;
      border-radius:.5rem;
      font-size:1rem;
    }
  </style>
{% else %}

{%- comment -%} ✅ Robust list of "done" words (comma-separated, trimmed later) {%- endcomment -%}
{%- assign YES_WORDS = "completed,approved,passed,done,ok,submitted,yes,active,cleared,verified" | split: "," -%}

{%- comment -%} --- Leader Review --- {%- endcomment -%}
{% assign leader_review_status = vi["Leader_Review"] | default: "pending" | downcase | strip %}
{% assign leader_review_done = false %}
{% if leader_review_status != "pending"  %}
  {% assign leader_review_done = true %}
{% endif %}

{%- comment -%} --- Background Checks completion --- {%- endcomment -%}
{% assign bc_total = 0 %}
{% assign bc_complete = 0 %}
{% if background_checks %}
  {% assign bc_total = background_checks.size %}
  {% for bc in background_checks %}
    {% assign s = bc["Background_Check_Status"] | downcase | strip %}
    {% assign done_flag = false %}
    {% for w in YES_WORDS %}
      {% assign w_t = w | downcase | strip %}
      {% if w_t != "" and s contains w_t %}
        {% assign done_flag = true %}
      {% endif %}
    {% endfor %}
    {% if done_flag %}
      {% assign bc_complete = bc_complete | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}
{% assign background_done = false %}
{% if bc_total == 0 or bc_total == bc_complete %}
  {% assign background_done = true %}
{% endif %}

{%- comment -%} --- Additional Requirements (milestones + certifications + forms) --- {%- endcomment -%}
{% assign req_total = 0 %}
{% assign req_complete = 0 %}

{% if milestones %}
  {% assign req_total = req_total | plus: milestones.size %}
  {% for m in milestones %}
    {% assign s = m["Milestone_Status"] | downcase | strip %}
    {% assign done_flag = false %}
    {% for w in YES_WORDS %}
      {% assign w_t = w | downcase | strip %}
      {% if w_t != "" and s contains w_t %}
        {% assign done_flag = true %}
      {% endif %}
    {% endfor %}
    {% if done_flag %}
      {% assign req_complete = req_complete | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if certifications %}
  {% assign req_total = req_total | plus: certifications.size %}
  {% for c in certifications %}
    {% assign s = c["Certification_Status"] | downcase | strip %}
    {% assign done_flag = false %}
    {% for w in YES_WORDS %}
      {% assign w_t = w | downcase | strip %}
      {% if w_t != "" and s contains w_t %}
        {% assign done_flag = true %}
      {% endif %}
    {% endfor %}
    {% if done_flag %}
      {% assign req_complete = req_complete | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if forms %}
  {% assign req_total = req_total | plus: forms.size %}
  {% for f in forms %}
    {% assign s = f["Form_Status"] | downcase | strip %}
    {% assign done_flag = false %}
    {% for w in YES_WORDS %}
      {% assign w_t = w | downcase | strip %}
      {% if w_t != "" and s contains w_t %}
        {% assign done_flag = true %}
      {% endif %}
    {% endfor %}
    {% if done_flag %}
      {% assign req_complete = req_complete | plus: 1 %}
    {% endif %}
  {% endfor %}
{% endif %}

{% assign addl_done = false %}
{% if req_total == 0 or req_total == req_complete %}
  {% assign addl_done = true %}
{% endif %}

{%- comment -%} --- Determine if any background check requirements exist --- {%- endcomment -%}
{% assign any_bc = false %}
{% if background_checks and background_checks.size > 0 %}
  {% assign any_bc = true %}
{% endif %}

{%- comment -%} --- Determine if any additional requirements exist --- {%- endcomment -%}
{% assign any_addl = false %}
{% if milestones and milestones.size > 0 %}{% assign any_addl = true %}{% endif %}
{% if certifications and certifications.size > 0 %}{% assign any_addl = true %}{% endif %}
{% if forms and forms.size > 0 %}{% assign any_addl = true %}{% endif %}

{%- comment -%} --- Ready to Serve (final) --- {%- endcomment -%}
{% assign ready_done = false %}
{% if leader_review_done and background_done and addl_done %}
  {% assign ready_done = true %}
{% endif %}

{%- comment -%} Determine current (first not done; Received is always done) {%- endcomment -%}
{% assign current_idx = 5 %}
{% assign s1_done = true %}
{% assign s2_done = leader_review_done %}
{% assign s3_done = background_done %}
{% assign s4_done = addl_done %}
{% assign s5_done = ready_done %}
{% if s2_done == false %}
  {% assign current_idx = 2 %}
{% elsif s3_done == false %}
  {% assign current_idx = 3 %}
{% elsif s4_done == false %}
  {% assign current_idx = 4 %}
{% elsif s5_done == false %}
  {% assign current_idx = 5 %}
{% endif %}

<div class="vt-shell">
  <header class="vt-header">
    <h1 class="vt-title">
      {{ vi["Nickname"] | default: "—" }} {{ vi["Last_Name"] | default: "" }}
    </h1>
    <div class="vt-subtitle">
      Volunteer Application for <strong>{{ vi["Opportunity_Title"] | default: "—" }}</strong>
      <span class="vt-dot">•</span>
      {% if vi["Response_Date"] %}
       Submitted on {{ vi["Response_Date"] | date: "%b %-d, %Y %I:%M %p" }}
      {% else %}—{% endif %}
      {% assign is_closed = vi["Closed"] | downcase %}
      {% if is_closed == true or is_closed == 'true' or vi["Closed"] == 1 %}
        <span class="vt-badge-closed">Closed</span>
      {% else %}
        <span class="vt-badge-open">Open</span>
      {% endif %}
    </div>
  </header>

  <!-- Domino’s-style LARGE SEGMENT TRACKER -->
  <section class="dom-tracker" aria-label="Volunteer onboarding progress">
  <div class="rail" role="list">
    {% assign stages = "Received
Leader Review" | split:"\n" %}
{% if any_bc %}
  {% assign stages = stages | push: "Background Check" %}
{% endif %}
{% if any_addl %}
  {% assign stages = stages | push: "Additional Requirements" %}
{% endif %}
{% assign stages = stages | push: "Ready to Serve!" %}


    {% for s in stages %}
      {% assign idx = forloop.index %}

      {%- comment -%} Determine raw done flags for each stage {%- endcomment -%}
      {% assign done = false %}
      {% if idx == 1 and s1_done %}{% assign done = true %}{% endif %}
      {% if idx == 2 and s2_done %}{% assign done = true %}{% endif %}
      {% if idx == 3 and s3_done %}{% assign done = true %}{% endif %}
      {% if idx == 4 and s4_done %}{% assign done = true %}{% endif %}
      {% if idx == 5 and s5_done %}{% assign done = true %}{% endif %}

      {%- comment -%} Current step is the first not-done stage {%- endcomment -%}
      {% assign current = false %}
      {% if current_idx == idx and done == false %}
        {% assign current = true %}
      {% endif %}

      {%- comment -%} Future steps: any stage to the right of current_idx {%- endcomment -%}
      {% assign future = false %}
      {% if idx > current_idx %}
        {% assign future = true %}
      {% endif %}

      {%- comment -%}
        Class logic:
        - Current: is-current
        - Done & NOT future: is-done
        - Otherwise (including done but future): is-pending
      {%- endcomment -%}
      <div class="seg{% if current %} is-current{% elsif done and future == false %} is-done{% else %} is-pending{% endif %}"
           role="listitem"
           aria-current="{% if current %}step{% else %}false{% endif %}">
        <div class="seg-label">{{ s }}</div>
        <div class="seg-sub">
          {% if idx == 1 %}
            Received ✓
          {% elsif idx == 2 %}
            {% if leader_review_done %}Approved{% else %}Awaiting leader review{% endif %}
          {% elsif idx == 3 %}
            {% if bc_total > 0 %}{{ bc_complete }}/{{ bc_total }} complete{% else %}No check required{% endif %}
          {% elsif idx == 4 %}
            {% if req_total > 0 %}{{ req_complete }}/{{ req_total }} complete{% else %}{% endif %}
          {% elsif idx == 5 %}
            {% if ready_done %}All set!{% else %}Pending prior steps{% endif %}
          {% endif %}
        </div>
        <div class="seg-glow" aria-hidden="true"></div>
      </div>
    {% endfor %}
  </div>
</section>

  <!-- Requirements detail list -->
  {% if any_bc or any_addl %}
  <section class="vt-reqs">
    <h2 class="vt-h2">Requirements</h2>

    {% if any_bc %}
    <div class="req-group">
      <div class="req-title">Background Check</div>
      {% if background_checks and background_checks.size > 0 %}
        <ul class="req-list">
          {% for bc in background_checks %}
            {% assign s = bc["Background_Check_Status"] | default: "Needed" %}
            {% assign s_l = s | downcase | strip %}
            {% assign item_done = false %}
            {% for w in YES_WORDS %}
              {% assign w_t = w | downcase | strip %}
              {% if w_t != "" and s_l contains w_t %}
                {% assign item_done = true %}
              {% endif %}
            {% endfor %}
            {% assign group_stage = 3 %}
            <li class="req-item {% if item_done %}is-done{% elsif group_stage > current_idx %}is-future{% else %}is-needed{% endif %}">
              <span class="req-status" aria-hidden="true"></span>
              <span class="req-text">
                {{ bc["Background_Check_Type"] | default: "Background Check" }}
                {% assign bc_url = bc["Background_Check_URL"] | default: "" | strip %}
                {% if item_done == false and bc_url != "" %}
                  <a class="req-action" href="{{ bc_url }}" target="_blank" rel="noopener noreferrer"
                    aria-label="Open background check form in a new tab">
                    Complete Background Check
                  </a>
                {% endif %}
                <span class="req-note">({% if item_done %}Complete{% else %}{{ s }}{% endif %})</span>
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="req-empty">No background check required.</p>
      {% endif %}
    </div>
    {% endif %}

    {% if any_addl %}
    <div class="req-group">
      <div class="req-title">Additional Requirements</div>
      {% assign any_addl = false %}
      {% if milestones and milestones.size > 0 %}{% assign any_addl = true %}{% endif %}
      {% if certifications and certifications.size > 0 %}{% assign any_addl = true %}{% endif %}
      {% if forms and forms.size > 0 %}{% assign any_addl = true %}{% endif %}

      
        <ul class="req-list">
          {% for m in milestones %}
            {% assign s = m["Milestone_Status"] | default: "Needed" %}
            {% assign s_l = s | downcase | strip %}
            {% assign item_done = false %}
            {% for w in YES_WORDS %}
              {% assign w_t = w | downcase | strip %}
              {% if w_t != "" and s_l contains w_t %}
                {% assign item_done = true %}
              {% endif %}
            {% endfor %}
            {% assign group_stage = 4 %}
            <li class="req-item {% if item_done %}is-done{% elsif group_stage > current_idx %}is-future{% else %}is-needed{% endif %}">
              <span class="req-status" aria-hidden="true"></span>
              <span class="req-text">
                <span>Milestone: {{ m["Milestone_Title"] | default: "Milestone" }}</span>
                <span class="req-note">({% if item_done %}Complete{% else %}{{ s }}{% endif %})</span>
              </span>
            </li>
          {% endfor %}

          {% for c in certifications %}
            {% assign s = c["Certification_Status"] | default: "Needed" %}
            {% assign s_l = s | downcase | strip %}
            {% assign item_done = false %}
            {% for w in YES_WORDS %}
              {% assign w_t = w | downcase | strip %}
              {% if w_t != "" and s_l contains w_t %}
                {% assign item_done = true %}
              {% endif %}
            {% endfor %}
            {% assign group_stage = 4 %}
            <li class="req-item {% if item_done %}is-done{% elsif group_stage > current_idx %}is-future{% else %}is-needed{% endif %}">
              <span class="req-status" aria-hidden="true"></span>
              <span class="req-text">
                <span>Certification: {{ c["Certification_Type"] | default: "Certification" }}</span>
                <span class="req-note">({% if item_done %}Complete{% else %}{{ s }}{% endif %})</span>
              </span>
            </li>
          {% endfor %}

          {% for f in forms %}
            {% assign s = f["Form_Status"] | default: "Needed" %}
            {% assign s_l = s | downcase | strip %}
            {% assign item_done = false %}
            {% for w in YES_WORDS %}
              {% assign w_t = w | downcase | strip %}
              {% if w_t != "" and s_l contains w_t %}
                {% assign item_done = true %}
              {% endif %}
            {% endfor %}
            {% assign group_stage = 4 %}
            <li class="req-item {% if item_done %}is-done{% elsif group_stage > current_idx %}is-future{% else %}is-needed{% endif %}">
              <span class="req-status" aria-hidden="true"></span>
              <span class="req-text">
                <span>Form: {{ f["Form_Title"] | default: "Form" }}</span>
                {% assign form_url = f["Form_URL"] | default: "" | strip %}
                {% if item_done == false and form_url != "" %}
                  <a class="req-action"
                    href="{{ form_url }}" target="_blank" rel="noopener noreferrer"
                    aria-label="Open form in a new tab">Complete Form</a>
                {% endif %}
                <span class="req-note">({% if item_done %}Complete{% else %}{{ s }}{% endif %})</span>
              </span>
            </li>
          {% endfor %}

        </ul>
    </div>
    {% endif %}
  </section>
  {% endif %}

  <!-- Help / Contact (below segments, above requirements) -->
  {% assign contact_first = vi["Opportunity_Contact_Nickname"] | default: "" %}
  {% assign contact_last  = vi["Opportunity_Contact_Last_Name"] | default: "" %}
  {% assign contact_email = vi["Opportunity_Contact_Email"] | default: "" %}
  <section class="vt-help">
    <p>
      <strong>Have a question or need help completing requirements?</strong>
      Contact <a href="mailto:{{ contact_email }}" target="_blank">{{ contact_first }} {{ contact_last }}</a>.
    </p>
  </section>
</div>

<style>
:root{
  --dom-blue:#0b66c3; /* current step */
  --dom-red:#d21034; /* completed primary red */
  --dom-red-dark:#a50e2b; /* deeper red for gradient */
  --ink:#0b1220;
  --muted:#64748b;
  --line:#e5e7eb;
  --ok:#16a34a;
  --warn:#f59e0b;
  --bg:#ffffff;
  /* seam overlap & skew angle */
  --seg-overlap: 6px; /* how much segments overlap to avoid gaps at skewed seams */
  --seg-skew: -10deg; /* visual tilt */
  --counter-skew: 10deg; /* cancel tilt for text/glow */
}
.vt-shell{max-width:1080px;margin:1.25rem auto;padding:1rem 1.25rem;background:var(--bg);
 font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--ink);}
.vt-header{margin-bottom:.75rem;}
.vt-title{margin:0;font-size:3rem;font-weight:800;letter-spacing:.2px;}
.vt-subtitle{color:var(--muted);margin-top:.25rem;font-size:1.25rem;}
.vt-dot{margin:0 .5rem;color:#cbd5e1;}
.vt-badge-closed{margin-left:.5rem;padding:.15rem .5rem;border-radius:.5rem;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;font-size:.85rem;}
.vt-badge-open{margin-left:.5rem;padding:.15rem .5rem;border-radius:.5rem;border:1px solid #bbf7d0;background:#bbf7d0;color:#16a34a;font-size:.85rem;}
/* --- Domino’s-style LARGE SEGMENT TRACKER (tilted segments) --- */
.dom-tracker{margin:1.25rem 0;}
.rail{display:flex; gap:0; position:relative;}
/* Base segment: skew the box, counter-skew the content */
.seg{
 position:relative; flex:1; min-height:86px;
 display:flex; flex-direction:column; align-items:center; justify-content:center;
 padding:.9rem .8rem; text-align:center;
 background:#f3f4f6; color:#1f2937; border:1px solid var(--line);
 transform: skewX(var(--seg-skew));
 overflow:hidden; border-radius:0;
 /* overlap neighbors slightly to hide skew seams */
 margin-right: calc(2 * var(--seg-overlap));
 will-change: transform;
}
/* Only first gets left rounding; only last gets right rounding */
.seg:first-child{ border-top-left-radius:16px; border-bottom-left-radius:16px; }
.seg:last-child{ border-top-right-radius:16px; border-bottom-right-radius:16px; margin-right:0; }
/* Avoid double borders at seams; last one keeps right border */
.seg:not(:last-child){ border-right:none; }
.seg + .seg{ position:relative; z-index:2; } /* keep later segments above the seam */
/* Counter-skew readable content */
.seg-label, .seg-sub, .seg-glow{ transform: skewX(var(--counter-skew)); }
.seg-label{ font-weight:900; font-size:1.05rem; line-height:1.2; color:#111827; letter-spacing:.2px; }
.seg-sub{ margin-top:.25rem; font-size:.95rem; color:#334155; opacity:.9; }
/* ✅ Completed: red gradient, white text, gentle red glow */
.seg.is-done{
 color:#ffffff;
 background:linear-gradient(135deg, var(--dom-red) 0%, #e11d48 40%, var(--dom-red-dark) 100%);
 border-color:transparent;
 box-shadow:0 4px 10px rgba(210,16,52,.20), 0 0 0 2px rgba(255,255,255,.5) inset;
}
.seg.is-done .seg-label, .seg.is-done .seg-sub{ color:#ffffff; }
.seg.is-done .seg-glow{
 pointer-events:none; position:absolute; inset:-1px; border-radius:inherit;
 background:radial-gradient(140px 70px at 50% 120%, rgba(255,255,255,.30), rgba(210,16,52,.20) 60%, transparent 80%);
 opacity:.45;
}
/* 🔵 Current: solid blue with animated glow */
.seg.is-current{
 color:#ffffff; background:var(--dom-blue); border-color:transparent;
 box-shadow:0 0 0 2px rgba(255,255,255,.65) inset, 0 0 0 3px rgba(11,102,195,.15), 0 8px 18px rgba(11,102,195,.35);
 animation:pulseGlow 1.4s ease-in-out infinite;
 transform: skewX(var(--seg-skew)) translateY(-1px); /* keep the skew and add a tiny lift */
}
.seg.is-current .seg-label, .seg.is-current .seg-sub{ color:#ffffff; }
.seg.is-current .seg-glow{
 pointer-events:none; position:absolute; inset:-1px; border-radius:inherit;
 background:radial-gradient(140px 70px at 50% 120%, rgba(255,255,255,.35), rgba(11,102,195,.18) 60%, transparent 80%);
 opacity:.5;
}
/* ⏳ Pending */
.seg.is-pending{ background:#f3f4f6; color:#475569; border-color:#e5e7eb; }
.seg.is-pending .seg-label{ color:#334155; }
.seg.is-pending .seg-sub{ color:#64748b; }
.seg.is-pending .seg-glow{ display:none; }
.seg-glow{ pointer-events:none; position:absolute; inset:-1px; border-radius:inherit; opacity:0; }
@keyframes pulseGlow{
 0%,100%{ box-shadow:0 0 0 2px rgba(255,255,255,.65) inset, 0 0 0 3px rgba(11,102,195,.12), 0 8px 18px rgba(11,102,195,.28); }
 50% { box-shadow:0 0 0 2px rgba(255,255,255,.8) inset, 0 0 0 4px rgba(11,102,195,.2), 0 10px 20px rgba(11,102,195,.42); }
}
/* Help / Contact */
.vt-help{ margin:.75rem 0 1rem; font-size:.98rem; color:var(--ink); }
.vt-help strong{ font-weight:800; }
.vt-help a{ color:var(--dom-blue); text-decoration:underline; }
/* --- Requirements list --- */
.vt-reqs{margin-top:1.25rem;}
.vt-h2{font-size:2rem;margin:.25rem 0 .75rem;font-weight:800;}
.req-group{margin-bottom:1rem;}
.req-title{margin:.25rem 0 .4rem;font-size:1.25rem;text-decoration:underline;color:#0f172a;font-weight:700;}
.req-list{list-style:none;padding:0;margin:.25rem 0 0;}
.req-item{display:flex;align-items:center;gap:.6rem;padding:.6rem .75rem;border:1px solid var(--line);
 border-radius:.6rem;margin-bottom:.45rem;background:#fff;}
.req-item.is-done{border-color:#bbf7d0;background:#f0fdf4;}
.req-item.is-needed{border-color: #facc15;background:#fff4e5;}
/* Future (not-yet) requirements: neutral gray */
.req-item.is-future{border-color:#e5e7eb;background:#f8fafc;}
.req-status{width:18px;height:18px;border-radius:50%;display:inline-block;flex:0 0 18px;}
.req-item.is-done .req-status{background:var(--ok);}
.req-item.is-needed .req-status{background:var(--warn);}
.req-item.is-future .req-status{background:#cbd5e1;} /* slate-300 */
.req-text{display:flex;flex-wrap:wrap;align-items:center;gap:.35rem;}
.req-note{color:var(--muted);font-size:.9rem;}
.req-action {
  margin-left: .5rem;
  font-weight: 700;
  color: var(--dom-blue);
  text-decoration: underline;
}
.req-item.is-future .req-action { opacity: .6; }
/* Responsive: soften tilt & seam overlap a bit on narrow screens for legibility */
@media (max-width: 900px){
 :root{ --seg-overlap: 5px; }
 .seg{ min-height:78px; padding:.85rem .6rem; }
 .seg-label{ font-size:1rem; }
 .seg-sub{ font-size:.9rem; }
}
@media (max-width: 640px){
 :root{ --seg-overlap: 4px; --seg-skew: -8deg; --counter-skew: 8deg; }
 .seg{ min-height:72px; padding:.75rem .5rem; }
 .seg:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px; }
 .seg:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px; }
 .seg-label{ font-size:.95rem; }
 .seg-sub{ font-size:.85rem; }
}
</style>
{% endif %}